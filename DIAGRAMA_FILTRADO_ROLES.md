# ğŸ“Š Diagrama Visual: Filtrado por Roles

## ğŸ¯ Flujo de Filtrado Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USUARIO LOGIN                            â”‚
â”‚                   (sapira@sapira.com - SAP)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SIDEBAR - Selector de Roles                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   SAP    â”‚  â”‚   CEO    â”‚  â”‚    BU    â”‚  â”‚   EMP    â”‚       â”‚
â”‚  â”‚ Sapira   â”‚  â”‚ Director â”‚  â”‚ Manager  â”‚  â”‚ Employee â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ SELECCIONA ROL â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                    â”‚
        â–¼                    â–¼                    â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   CEO  â”‚          â”‚   BU    â”‚         â”‚   EMP    â”‚
   â”‚        â”‚          â”‚ Manager â”‚         â”‚          â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
```

## ğŸ” QuÃ© Ve Cada Rol

### ğŸ‘‘ CEO / SAP
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VE TODO - Sin Filtros                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… Initiatives                             â”‚
â”‚     â€¢ Finance                               â”‚
â”‚     â€¢ Sales                                 â”‚
â”‚     â€¢ HR                                    â”‚
â”‚     â€¢ Legal                                 â”‚
â”‚     â€¢ Procurement                           â”‚
â”‚     â€¢ [todas las BUs]                       â”‚
â”‚                                             â”‚
â”‚  âœ… Projects (todos)                        â”‚
â”‚     â€¢ Invoicing                             â”‚
â”‚     â€¢ Pricing                               â”‚
â”‚     â€¢ NPS                                   â”‚
â”‚     â€¢ Negotiation                           â”‚
â”‚     â€¢ [todos los proyectos]                 â”‚
â”‚                                             â”‚
â”‚  âœ… Issues (todos)                          â”‚
â”‚     â€¢ GON-1 a GON-N                         â”‚
â”‚     â€¢ [todos los issues]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Filter Preset: null
Badge: (ninguno)
```

### ğŸ¢ BU Manager (Ejemplo: Finance)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FILTRADO A: Finance                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… Initiatives                             â”‚
â”‚     â€¢ Finance                               â”‚
â”‚                                             â”‚
â”‚  âœ… Projects (solo Finance)                 â”‚
â”‚     â€¢ Invoicing                             â”‚
â”‚     â€¢ Pricing                               â”‚
â”‚     â€¢ Accounting                            â”‚
â”‚                                             â”‚
â”‚  âœ… Issues (solo Finance)                   â”‚
â”‚     â€¢ GON-36: Invoice AutoFlow              â”‚
â”‚     â€¢ GON-47: InvoiceGenius                 â”‚
â”‚     â€¢ GON-50: FraudFinder AI                â”‚
â”‚     â€¢ GON-69: Collections Assistant         â”‚
â”‚     â€¢ GON-80: FinanceGuardian               â”‚
â”‚     â€¢ [solo issues de Finance]              â”‚
â”‚                                             â”‚
â”‚  âŒ NO VE:                                  â”‚
â”‚     â€¢ Sales, HR, Legal, etc.                â”‚
â”‚     â€¢ Proyectos de otras BUs                â”‚
â”‚     â€¢ Issues de otras BUs                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Filter Preset: "my-bu"
Badge: "Filtered to: My BU" ğŸŸ¦
```

### ğŸ‘¤ Employee
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FILTRADO A: Mis Issues                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… Initiatives (relacionadas)              â”‚
â”‚     â€¢ [BUs donde tiene issues]              â”‚
â”‚                                             â”‚
â”‚  âœ… Projects (relacionados)                 â”‚
â”‚     â€¢ [Proyectos donde tiene issues]        â”‚
â”‚                                             â”‚
â”‚  âœ… Issues (solo los suyos)                 â”‚
â”‚     WHERE:                                  â”‚
â”‚       assignee_id = user_id                 â”‚
â”‚       OR reporter_id = user_id              â”‚
â”‚                                             â”‚
â”‚     Ejemplo:                                â”‚
â”‚     â€¢ GON-12: Issue asignado a mÃ­           â”‚
â”‚     â€¢ GON-45: Issue reportado por mÃ­        â”‚
â”‚     â€¢ GON-78: Issue donde colaboro          â”‚
â”‚                                             â”‚
â”‚  âŒ NO VE:                                  â”‚
â”‚     â€¢ Issues de otros empleados             â”‚
â”‚     â€¢ Initiatives completas                 â”‚
â”‚     â€¢ Proyectos sin su participaciÃ³n        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Filter Preset: "mine"
Badge: "Filtered to: Me" ğŸŸ¦
```

## ğŸ”„ Flujo de Datos TÃ©cnico

```
1ï¸âƒ£ USUARIO CAMBIA DE ROL
   â”‚
   â”œâ”€ Sidebar.tsx
   â”‚  â””â”€ handleRoleChange(newRole)
   â”‚     â””â”€ useRoles.switchRole(newRole)
   â”‚        â””â”€ localStorage.setItem('os.demoRole', newRole)
   â”‚
   â–¼
2ï¸âƒ£ HOOK DETECTA CAMBIO DE ROL
   â”‚
   â”œâ”€ useRoles.activeRole actualizado
   â”‚  â””â”€ getFilterPreset() devuelve:
   â”‚     â€¢ null (CEO/SAP)
   â”‚     â€¢ "my-bu" (BU Manager)
   â”‚     â€¢ "mine" (Employee)
   â”‚
   â–¼
3ï¸âƒ£ HOOK DE DATOS SE ACTUALIZA
   â”‚
   â”œâ”€ use-supabase-data.ts
   â”‚  â””â”€ useEffect([activeRole, currentOrg])
   â”‚     â”‚
   â”‚     â”œâ”€ getCurrentUser() devuelve:
   â”‚     â”‚  â€¢ userId (real o mock)
   â”‚     â”‚  â€¢ initiativeId (BU del usuario)
   â”‚     â”‚
   â”‚     â””â”€ Carga datos con filtros:
   â”‚        â”‚
   â”‚        â”œâ”€ loadTriageIssues()
   â”‚        â”‚  â””â”€ IssuesAPI.getTriageIssues(orgId)
   â”‚        â”‚
   â”‚        â”œâ”€ loadRoleIssues()
   â”‚        â”‚  â””â”€ IssuesAPI.getIssuesByRole(orgId, role, userId, initiativeId)
   â”‚        â”‚     â”‚
   â”‚        â”‚     â””â”€ SQL aplica filtros:
   â”‚        â”‚        â€¢ BU: WHERE initiative_id = initiativeId
   â”‚        â”‚        â€¢ EMP: WHERE assignee_id = userId OR reporter_id = userId
   â”‚        â”‚        â€¢ CEO/SAP: (sin filtros)
   â”‚        â”‚
   â”‚        â”œâ”€ loadInitiatives()
   â”‚        â”‚  â””â”€ InitiativesAPI.getInitiatives()
   â”‚        â”‚     â””â”€ Filtrado en JS:
   â”‚        â”‚        â€¢ BU: filter(i => i.id === initiativeId)
   â”‚        â”‚        â€¢ EMP: []
   â”‚        â”‚        â€¢ CEO/SAP: (todas)
   â”‚        â”‚
   â”‚        â””â”€ loadProjects()
   â”‚           â””â”€ ProjectsAPI.getProjects()
   â”‚              â””â”€ Filtrado en JS:
   â”‚                 â€¢ BU: filter(p => p.initiative_id === initiativeId)
   â”‚                 â€¢ EMP: (proyectos con sus issues)
   â”‚                 â€¢ CEO/SAP: (todos)
   â”‚
   â–¼
4ï¸âƒ£ UI SE ACTUALIZA
   â”‚
   â”œâ”€ PÃ¡ginas usan: const { initiatives, projects, roleIssues } = useSupabaseData()
   â”‚  â”‚
   â”‚  â”œâ”€ /initiatives â†’ Muestra solo initiatives permitidas
   â”‚  â”œâ”€ /projects â†’ Muestra solo projects permitidos
   â”‚  â””â”€ /issues â†’ Muestra solo roleIssues permitidos
   â”‚
   â””â”€ Sidebar muestra:
      â€¢ Badge "Filtered to: My BU" (BU Manager)
      â€¢ Badge "Filtered to: Me" (Employee)
      â€¢ (sin badge para CEO/SAP)
```

## ğŸ¨ Ejemplo Visual en UI

### Sidebar con BU Manager seleccionado:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Gonvarri      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [BU Manager â–¼]  ğŸ” âš™  â”‚ â† Selector de roles
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Filtered to:    â”‚   â”‚ â† Badge indicador
â”‚  â”‚    My BU        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WORKSPACE              â”‚
â”‚  â–¡ Projects             â”‚ â† Solo 3 proyectos de Finance
â”‚  â–¡ Initiatives          â”‚ â† Solo 1: Finance
â”‚                         â”‚
â”‚  QUICK ACCESS           â”‚
â”‚  â–¡ Surveys              â”‚
â”‚  â–¡ My Sapira Relations  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Tabla Comparativa

| CaracterÃ­stica           | SAP/CEO | BU Manager | Employee |
|-------------------------|---------|------------|----------|
| Ve todas las BUs        | âœ…      | âŒ         | âŒ       |
| Ve su propia BU         | âœ…      | âœ…         | âš ï¸*      |
| Ve todos los proyectos  | âœ…      | âŒ         | âŒ       |
| Ve proyectos de su BU   | âœ…      | âœ…         | âš ï¸*      |
| Ve todos los issues     | âœ…      | âŒ         | âŒ       |
| Ve issues de su BU      | âœ…      | âœ…         | âš ï¸*      |
| Ve sus propios issues   | âœ…      | âœ…         | âœ…       |
| Puede cambiar de rol    | âœ…      | âŒ         | âŒ       |
| Triage visible          | âœ…      | âœ… (opc)   | âŒ       |
| Badge en sidebar        | âŒ      | âœ…         | âœ…       |

\* Solo si tiene issues en esa BU

## ğŸ” Seguridad

El filtrado se implementa en **mÃºltiples capas**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Capa 1: Permisos (use-roles.ts)       â”‚
â”‚  â”œâ”€ Define quÃ© puede ver cada rol       â”‚
â”‚  â””â”€ Devuelve filterPreset                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Capa 2: LÃ³gica (use-supabase-data.ts) â”‚
â”‚  â”œâ”€ Obtiene userId e initiativeId       â”‚
â”‚  â”œâ”€ Llama a APIs con filtros            â”‚
â”‚  â””â”€ Filtra results en frontend          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Capa 3: API/SQL (lib/api/*.ts)        â”‚
â”‚  â”œâ”€ Aplica filtros en queries SQL       â”‚
â”‚  â”œâ”€ WHERE initiative_id = ?             â”‚
â”‚  â””â”€ WHERE assignee_id = ? OR ...        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

âœ… **Beneficios**:
- No se puede bypassear desde el navegador
- Filtrado eficiente en base de datos
- CÃ³digo mantenible y testeable

## ğŸš€ Demo Script

Para mostrar el sistema en una presentaciÃ³n:

1. **Login** como SAP (pantalla completa)
2. **Mostrar todo** (6 BUs, 15 proyectos, 100 issues)
3. **Click** en selector de roles â†’ "BU Manager"
4. **Â¡Poof!** ğŸ’¨ Ahora solo 1 BU, 3 proyectos, 12 issues
5. **Badge aparece**: "Filtered to: My BU"
6. **Navegar**: /initiatives â†’ Solo Finance
7. **Navegar**: /projects â†’ Solo proyectos Finance
8. **Cambiar** a "Employee"
9. **Â¡Poof!** ğŸ’¨ Ahora solo 5 issues propios
10. **Badge actualiza**: "Filtered to: Me"
11. **Volver** a CEO/SAP â†’ Todo visible de nuevo

â±ï¸ **DuraciÃ³n**: 2 minutos  
ğŸ¯ **Impacto**: Alto - Muestra poder del sistema de permisos


